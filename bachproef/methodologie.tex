%%=============================================================================
%% Methodologie
%%=============================================================================

\chapter{\IfLanguageName{dutch}{Methodologie}{Methodology}}
\label{ch:methodologie}

\section{Uitleg termen}
In tabel 3.1 zijn termen terug te vinden die in dit hoofdstuk regelmatig zullen voorkomen.

\begin{table}[]
	\resizebox{\textwidth}{!}{%
		\begin{tabular}{|l|p{15cm}|}
			\hline 
			Queue & Een wachtrij waar berichten op geplaatst worden. Het bericht op de queue kan maar één keer gelezen worden. \\ \hline
			Consumption & De term om een bericht van de queue te lezen. \\ \hline
			Acknowledgement & Het verwijderen van een bericht op de queue. \\ \hline
			Overhead &  Als er teveel data aanwezig is op de queue dan spreekt men van overhead. Dit kan er voor zorgen dat de queue geen berichten meer ontvangt. \\ \hline
			Datastore &  Een datastore is een kleinere versie van een databank. Er kunnen files in opgeslaan worden, alsook gegevens. \\ \hline
		\end{tabular}%
	}
	\caption{Termen die vaker voorkomen in dit hoofdstuk.}
\end{table}

\section{Communicatie methode in het algemeen uitgelegd}
\begin{figure}[h]
	\includegraphics[width=15cm]{schemaEM.png}
	\caption{Hoe de messaging zou toegepast worden binnen het proces.}
	\centering
\end{figure}
Microservices moeten met elkaar kunnen communiceren. De manier wordt voorgesteld in figuur 3.1. 
Klant 66 plaats een order met vier verschillende producten. Het ordernummer is 23. De volledige bestelling komt binnen in het systeem en wordt op de queue van ordermanagement geplaatst. Het order wordt van de queue gehaald aan de hand van consumption en acknowledgement. Ordermanagement verwerkt de binnengekomen order. Dan wordt het klantnummer en ordernummer op de queue van creditmanagement geplaatst. Creditmanagement haalt het bericht van de queue. Dan wordt er gekeken naar het betaalgedrag van de klant. Is het een wanbetaler of betaald de klant altijd correct. Staat de klant gekend voor wanbetalen, dan wordt er geen goedkeuring gegeven om het order te plaatsen. Bij een corect betaalgedrag, krijgt de order goedkeuring om geplaatst te worden. Dan wordt het ordernummer doorgestuurd naar het volgende deel van het proces. 
Dus volgende queue's zouden moeten bestaan:
\begin{itemize}
	\item QorderMan is een queue voor order management: Het plaatsen van een order.
	\item QcreditMan is een queue voor credit management: Om te controleren of een klant wel een order mag plaatsen.
	\item QorderFul is een queue voor order fulfilment: Het ophalen van de order in het magazijn.
	\item QorderShip is een queue voor order shipment: Het plannen van de route en welke goederen op welke vrachtwagen moeten geladen worden.
	\item Qfact is een queue voor de facturatie.
	\item QaccountsRec is een queue voor accounts receivable: De betaling van de factuur nagaan en tijdig aanmaningen sturen. 
\end{itemize}

Niet alle data wordt volledig naar de queue gestuurd enkel de belangrijke data. Zoals bijvoorbeeld het nummer van de klant die een order plaatste. Het ordernummer en klantnummer worden naar creditmanagement doorgestuurd. Bij creditmanangement wordt er dan aan de hand van het klantnummer de gegevens opgehaald en dan zo nagegaan of die klant wel een order mag plaatsen. Het ordernummer werd meegestuurd om zeker te zijn dat de correcte order goed- of afgekeurd wordt. Zo blijft de overhead op de queue minimaal. Om meer gegevens op te halen, moet de databank aangesproken worden. De gehele structuur van de databank wordt beschreven in het volgende gedeelte.

\section{De databank structuur}
Onderliggend is één grote databank waar alle masterdata in terug te vinden is. Hier is de enige plaats waar een single point-of-failure terug te vinden is. Naast de grote databank, heeft elke microservice zijn datastore. Bij een verandering in een datastore, stuurt deze de nieuwe record naar de databank zijn queue. Eens de databank de record heeft toegevoegd of aangepast, stuurt hij een bericht naar elke datastore zijn queue om te melden dat er een verandering gebeurt is. 
\begin{figure}[h]
	\includegraphics[width=15cm]{databank.png}
	\caption{De databank structuur.}
	\centering
\end{figure}

Een order weet wie zijn klant is. Dit is zodat het credit management de eigenschap bij de order kan veranderen van 'goedgekeurd' naar 'niet goedgekeurd'. Van elk order wordt ook een orderlijn bijgehouden. Zodat er geweten is wat er op de order staat. Op elk orderlijn staat er een product of service. Van het product moet er een beschrijving en verkoopprijs geweten zijn. Het aantal in voorraad is ook gekend omdat bij het order fullfilment moet de voorraad aangepast worden van het specifieke product. Een order en de klant zijn gekend op de facturatie. Zo kan er nagegaan worden of de factuur overeenkomt met wat er op het order staat. De klant zijn gegevens moeten gekend zijn om naar het juiste adres te factureren.


\section{De verschillende microservices}
Voor elk van volgende microservices gaan we volgende vragen beantwoorden:
\begin{itemize}
	\item Wat kunnen ze?
	\item Hoe ziet de databank eruit?
	\item Welk deeltje van de databank spreken ze aan?
	\item Waar kunnen ze gebruikt worden?
	\item Waarom werd hiervan een microservice gemaakt?
\end{itemize}

\subsection{Klantengegevens ophalen}
Deze microservice gaat ervoor zorgen dat de klantengegevens uit de databank worden gehaald. Het zal de databank aanspreken en vragen om de data van een specifieke klant. 
Hoe het schema van de databank er uit ziet, is terug te vinden in het vorige deel. 
Deze microservice wordt gebruikt in meerdere delen van het order-to-cash proces. Een van de voordelen van microservices is de schaalbaarheid. Omdat de requirement meermaals zal voorkomen in het proces, is het voordeliger om de microservice te dupliceren en te hergebruiken. 
Deze microservice komt voor in volgende onderdelen:
\begin{itemize}
	\item Order management
	\item Credit management
	\item Klant management
	\item Facturatie
	\item Accounts receivables
\end{itemize}

\subsection{Orders plaatsen, ophalen en verwijderen}
Een belangrijk onderdeel is het plaatsen, ophalen en verwijderen van orders. Deze microservice heeft verschillende verantwoordelijkheden en rechten op de databank. 
Deze microservice zal gebruikt worden in volgende onderdelen:
\begin{itemize}
	\item Order management
	\item Order fullfilment
	\item Facturatie
\end{itemize}

\subsection{Producten ophalen en het aantal in voorraad veranderen}
In het order-to-cash proces worden er geen producten toegevoegd aan de lijst dus moet dit niet in een microservice gestoken worden. Het aantal van de voorraad moet worden aangepast wanneer er een product uit de rekken wordt gehaald en bij een bestelling wordt geplaatst. Het ophalen van producten is vooral voor het werk achter de schermen. Het ophalen van een product omvat vooral de verkoopprijs ophalen om die dan te gebruiken in de orderlijn. 
Deze microservice zal gebruikt worden in volgende onderdelen:
\begin{itemize}
	\item Order management
	\item order fullfilment
\end{itemize}

\subsection{Facturatie maken en ophalen}
Het begin van het einde in een order-to-cash proces. Facturen maken en ophalen zijn van groot belang bij een order-to-cash proces. Het zorgt er voor dat mensen geld gaan betalen voor hun order. Een factuur moet overeenstemmen met wat geleverd is. Het is van groot belang dat achter kan gekeken worden of de factuur ook klopt met de order. Het maken van de factuur gebeurt ook aan de hand van het order. 
Deze microservice komt voor in het onderdeel facturatie.

\subsection{Shipment documentatie opstellen}
Het shipment document wordt gegenereerd afhankelijk van het order. Er wordt gekeken naar het ordernummer en dan wordt er gekeken naar het klantnummer. Hierna wordt dan de microservice om klantgegevens op te halen aangesproken om de gegevens van de specifieke klant op te halen. Dit wordt enkel gebruikt binnen het onderdeel verzending.

\subsection{Aanmaning opmaken en verwijderen}
Het opmaken en verwijderen van aanmaningen gebeurt enkel wanneer een wanbetaler is. Het proces zou niet vaak mogen voorkomen. 

\subsection{Berichten plaatsen op de queue}
Berichten plaatsen op de queue met de correcte gegevens. Deze microservice zorgt daarvoor. Hiervan wordt ook een microservice gemaakt omdat dit in elke stap voorkomt. Het is dan eenvoudiger om er een microservice van te maken, zodat elk onderdeel op een uniforme manier het bericht plaatst. 
Deze microservice komt voor in elk onderdeel van het proces.

\subsection{Berichten ophalen van de queue} 
Elk onderdeel moet berichten van zijn queue kunnen halen. Door het meermaals voorkomen van deze taak, wordt er een microservice van gemaakt. Het ophalen van berichten gebeurt dan op een uniforme manier. 
Deze microservice komt voor in elk onderdeel van het proces.


\section{De complete architectuur opbouwen}
Op figuur 3.3 is te zien hoe het proces in elkaar ziet. Door de microservice architectuur toe te passen op het order-to-cash proces verandert er niks aan de volgorde van het proces of het doel van het proces. De manier waarop gegevens worden opgehaald, verandert wel. 

\subsection{De communicatie tussen de microservices}

\begin{figure}[h]
	\includegraphics[width=15cm]{schema_communicatie.png}
	\caption{De communicatie tussen de verschillende onderdelen van het order-to-cash proces.}
	\centering
\end{figure}
Op figuur 3.3 is het communicatie patroon zichtbaar.
Voordat het proces van start kan gaan, moet een klant een order plaatsen. Een order bevat een aantal producten. Eens de klant een order geplaatst heeft dan is er een ordernummer gekend. De klant staat bekend in het systeem met een klantnummer. Dat zijn twee belangrijke gegevens die veel gebruikt zullen worden.
Meer uitleg over wat elk onderdeel doet, bevindt zich in het volgende hoofdstuk.
De nummers van de opsomming komen overeen met die op afbeelding 3.3.
\begin{enumerate}
	\item De communicatie tussen ordermanagement en creditmanagement. Er is een order geplaatst door klant 66. Ordermanagement zorgt ervoor dat het order in de databank geraakt. Eens de taak van ordermanagement gedaan is, plaatst die het klantnummmer en het ordernummer op de queue van creditmanagement. Dan is zijn taak gedaan. Ordermanagement houdt zich niet bezig met wat er gebeurt nadat hij het bericht geplaatst heeft.
	\item De communicatie tussen creditmanagement en order fullfilment. Creditmanagement heeft het ordernummer en klantnummer van ordermanagement gekregen. Het bericht wordt van de queue gehaald. Creditmanagement gaat dan aan de hand van de klantgegevens beslissen of de klant het order mag plaatsen of niet. Is het order goedgekeurd dan wordt het ordernummer op de queue van order fullfilment gezet. De taak van creditmanagement is nu afgerond.
	\item De communicatie tussen order fullfilment en order shipment. Order fullfilment heeft het ordernummer doorgekregen van credit management. Order fullfilment geeft het ordernummer door aan order shipment eens zijn taak gedaan is. 
	\item De communicatie tussen order shipment en de facturatie. Het ordernummer werd op de queue van order shipment geplaatst. Eens alles opgemaakt is bij order shipment, wordt het ordernummer doorgestuurd naar de facturatie. De taak van order shipment is afgerond.
	\item De communicatie tussen facturatie en accounts receivables. De facturatie kreeg een bericht van order shipment om de factuur op te maken voor het order met des betreffende ordernummer. Is de taak van facturatie afgerond dan wordt de factuurnummer doorgestuurd naa accounts receivables. Zodat de betaling verder kan worden opgevolgd.
	\item Ordermanagement plaatst het ordernummer op de queue van klant management. Klant managment stuurt een bevestiging naar de klant van het goed ontvangen van zijn/haar order. En laat weten dat er eerst een controle komt op het betaalbedrag van de klant.
	\item Creditmanagement plaatst het ordernummer en de status van goedgekeurd of afgekeurd op de queue. Dan wordt er een bericht verzonden naar de klant. Het bericht bevat de info of de klant zijn order is goedgekeurd of afgekeurd.
	\item Order fullfilment plaatst een bericht op de queue om te laten weten dat het order gemaakt is. Dat de goederen uit het magazijn zijn opgehaald en klaar gemaakt worden voor verzending.
	\item Order shipment plaatst een bericht op de queue wanneer de goederen klaar zijn voor vertrek. Klant management zorgt er dan voor dat het bericht tot bij de klant geraakt.
	\item Facturatie plaatst een bericht op de queue van klant management om ervoor te zorgen dat de factuur tot bij de klant geraakt.
	\item Accounts receivables plaatst een bericht op de queue van klant management als er aanmaningen moeten worden gestuurd.
\end{enumerate}

\subsection{Welk onderdeel spreekt welke microservices aan?}
\begin{figure}[h]
	\includegraphics[width=15cm]{schema_microservices.png}
	\caption{Welk onderdeel, welke microservices aanspreekt.}
	\centering
\end{figure}
